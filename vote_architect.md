# Αναδιάρθρωση Λογικής Ψηφοφοριών (e‑voting + pre‑voting)

Στόχος: να ενσωματώσουμε **ηλεκτρονική ψηφοφορία ως κύριο κανάλι** και **pre‑voting (ψηφιακή δια περιφοράς)** με τρόπο λειτουργικό, ελέγξιμο και νομικά θωρακισμένο, χωρίς να αποκλείονται όσοι δηλώνουν τεκμηριωμένη αδυναμία χρήσης.

---

## 1) Αρχές και σχεδιαστικές παραδοχές

- **Electronic‑first**: το e‑voting είναι το βασικό κανάλι συμμετοχής.
- **Pre‑voting**: ορίζεται σαφές παράθυρο ψηφοφορίας πριν/μέχρι τη λήξη, με δυνατότητα αλλαγής επιλογής.
- **Last‑vote‑wins**: μόνο η τελευταία υποβολή πριν το κλείδωμα θεωρείται έγκυρη.
- **1 ψήφος ανά οριζόντια ιδιοκτησία** (με στάθμιση χιλιοστών).
- **Ακεραιότητα & auditability**: πλήρες audit trail και παραγωγή “evidence package”.
- **Ελάχιστο safety‑valve**: μια τεκμηριωμένη οδός για μη ψηφιακή συμμετοχή.

---

## 2) Ρόλοι & δικαιώματα

- **Διαχειριστής/Πρόεδρος**: δημιουργία ψηφοφορίας, έκδοση ballots, κλείδωμα, εξαγωγή πρακτικών.
- **Ιδιοκτήτης/Νόμιμος εκπρόσωπος**: υποβολή/αλλαγή ψήφου, πρόσβαση σε αποδεικτικό.
- **Εξουσιοδοτημένος**: ψηφίζει βάσει ενεργής εξουσιοδότησης.

---

## 3) Ροή διαδικασίας (λειτουργική λογική)

### 3.1 Προετοιμασία
1) Δημιουργία ψηφοφορίας (θέματα, επιλογές, στάθμιση, προθεσμίες).
2) Ανάρτηση/επισύναψη εισηγήσεων, προσφορών, τεχνικών εκθέσεων.
3) Έκδοση ballots ανά οριζόντια ιδιοκτησία.

### 3.2 Παράθυρο Pre‑Voting
- **Άνοιγμα**: `opens_at`
- **Κλείσιμο**: `closes_at`
- Υποβολή/αντικατάσταση ψήφου επιτρέπεται μόνο εντός παραθύρου.

### 3.3 Κλείδωμα και Καταμέτρηση
- Μετά το `closes_at`, **κλειδώνει** η ψηφοφορία.
- Παράγεται **πρακτικό αποτελέσματος** και **hashes**.
- Δεν υπάρχουν “ενδιάμεσα αποτελέσματα”.

### 3.4 Safety‑Valve (ελάχιστη πρόβλεψη)
- Σε τεκμηριωμένη αδυναμία χρήσης πλατφόρμας, επιτρέπεται **έγγραφη/υπογεγραμμένη δήλωση ψήφου**.
- Ο διαχειριστής καταχωρίζει τη δήλωση στην πλατφόρμα, με **audit event** και συνημμένο.

---

## 4) Νομική θωράκιση – Κείμενο για Πρακτικό Γ.Σ.

> Χρήση ως πρότυπο/παράρτημα. Είναι σύντομο, αλλά καλύπτει τα κρίσιμα σημεία.

### ΤΙΤΛΟΣ
**ΑΠΟΦΑΣΗ Γ.Σ. – Θέσπιση ηλεκτρονικής δια περιφοράς ψηφοφορίας (e‑voting / pre‑voting)**

### ΠΡΟΟΙΜΙΟ
Η Γενική Συνέλευση των συνιδιοκτητών της πολυκατοικίας [ΔΙΕΥΘΥΝΣΗ], συνελθούσα την [ΗΜ/ΝΙΑ], αποφασίζει τη θέσπιση διαδικασίας ηλεκτρονικής ψηφοφορίας, με σκοπό την αύξηση συμμετοχής και την αποφυγή του πρακτικού εμποδίου του ταυτοχρονισμού, με τρόπο ελέγξιμο και μη διαβλητό.

### Άρθρο 1 – Βασικές αρχές
1. Η λήψη αποφάσεων δύναται να γίνεται και ηλεκτρονικά, δια περιφοράς, εντός καθορισμένου χρονικού παραθύρου (pre‑voting).
2. Η ηλεκτρονική διαδικασία ισχύει ως κύριος τρόπος συμμετοχής για τα θέματα που τίθενται σε ψηφοφορία.

### Άρθρο 2 – Πρόσκληση & ενημέρωση
Η πρόσκληση περιλαμβάνει: ημερήσια διάταξη, διατύπωση ερωτήματος/επιλογών, συνημμένα στοιχεία, χρόνο έναρξης‑λήξης, τρόπο ταυτοποίησης και κανόνες εξουσιοδότησης.

### Άρθρο 3 – Δικαίωμα ψήφου & χιλιοστά
Δικαίωμα ψήφου έχουν οι συνιδιοκτήτες/νόμιμοι εκπρόσωποι ανά οριζόντια ιδιοκτησία. Η καταμέτρηση γίνεται βάσει χιλιοστών/ποσοστών.

### Άρθρο 4 – Ταυτοποίηση & υποβολή ψήφου
Η υποβολή ψήφου γίνεται μόνο μετά από ισχυρή ταυτοποίηση. Για κάθε δικαιούχο/ιδιοκτησία εκδίδεται μοναδικό δικαίωμα συμμετοχής (ballot). Με την υποβολή, εκδίδεται αποδεικτικό καταχώρισης (receipt) με μοναδικό αναγνωριστικό και χρόνο.

### Άρθρο 5 – Αλλαγή ψήφου έως τη λήξη
Μέχρι τη λήξη της προθεσμίας, ο δικαιούχος δύναται να τροποποιήσει την επιλογή του. Ως έγκυρη λογίζεται η τελευταία χρονικά καταχωρισμένη ψήφος πριν το κλείδωμα.

### Άρθρο 6 – Καταμέτρηση & πρακτικό αποτελέσματος
Μετά το κλείδωμα, γίνεται καταμέτρηση και παράγεται Πρακτικό Αποτελέσματος με συμμετοχές, χιλιοστά, ψήφους ανά θέμα και τελικό αποτέλεσμα. Το πρακτικό δύναται να υπογράφεται ηλεκτρονικά.

### Άρθρο 7 – Αποδεικτικά & ακεραιότητα
Τηρείται audit trail με τρόπο ταυτοποίησης, χρόνο υποβολής, κανάλι υποβολής και κατάσταση ψήφου. Τα αποδεικτικά αρχειοθετούνται.

### Άρθρο 8 – Ελάχιστη πρόβλεψη αδυναμίας χρήσης
Σε τεκμηριωμένη αδυναμία χρήσης της πλατφόρμας, ο δικαιούχος μπορεί να καταθέσει έγγραφη/υπογεγραμμένη δήλωση ψήφου προς τον διαχειριστή έως τη λήξη, η οποία καταχωρίζεται στην πλατφόρμα και αρχειοθετείται.

### Άρθρο 9 – Τήρηση αρχείου
Πρακτικά, εξουσιοδοτήσεις και αποδεικτικά ψηφοφορίας τηρούνται για [π.χ. 5] έτη, κατά τρόπο συμβατό με την προστασία δεδομένων.

### Άρθρο 10 – Ισχύς
Η παρούσα απόφαση ισχύει από [ΗΜ/ΝΙΑ].

---

## 5) Αρχιτεκτονική δεδομένων (Backend)

**Core entities**
- `Unit` (οριζόντια ιδιοκτησία)
- `OwnershipShare` (χιλιοστά, ισχύς από/έως)
- `Vote` (θέματα, opens_at, closes_at, status)
- `VoteQuestion` (κείμενο, επιλογές, τύπος)
- `Ballot` (ένα ανά Vote+Unit, token hashed)
- `VoteSubmission` (choice, timestamp, channel, superseded_by)
- `ProxyAuthorization` (εξουσιοδότηση + attachment)
- `AuditEvent` (append‑only, hash‑chain)
- `EvidencePackage` (results_hash, audit_root_hash, artifacts)

**Κρίσιμα constraints**
- Δεν υπάρχει 2ο ενεργό ballot για το ίδιο Unit στο ίδιο Vote.
- Κάθε νέα υποβολή κάνει supersede την προηγούμενη (last‑vote‑wins).
- Υποβολές μόνο όταν `opens_at <= now < closes_at`.

---

## 6) Business rules & υπηρεσίες

- `issue_ballots()` δημιουργεί ballots ανά Unit.
- `submit_vote()`:
  - επιβεβαιώνει δικαίωμα/εξουσιοδότηση
  - ελέγχει παράθυρο
  - δημιουργεί νέο submission και supersede το προηγούμενο
  - παράγει receipt
- `close_vote()`:
  - κλειδώνει
  - υπολογίζει αποτελέσματα
  - παράγει hashes (results/audit)
- Καμία δημοσίευση αποτελεσμάτων πριν το κλείδωμα.

---

## 7) API (DRF / ViewSet actions)

- `POST /api/votes/{id}/issue-ballots/` (manager)
- `GET /api/votes/{id}/my-ballot/`
- `POST /api/votes/{id}/submit/`
- `POST /api/votes/{id}/close/` (manager)
- `GET /api/votes/{id}/results/`
- `GET /api/votes/{id}/evidence-package/`
- `GET /api/votes/{id}/audit-summary/`

---

## 8) Evidence package & Πρακτικό Αποτελέσματος

**Artifacts**
- `praktiko.pdf` ή HTML→PDF
- `results.json`
- `audit.jsonl` ή `audit_summary.json`
- `results_hash`, `audit_root_hash`

**Strict mode (optional)**
- Υπογραφή πρακτικού με **QES**
- Qualified timestamp για hashes

---

## 9) Frontend (Next.js)

- Προβολή κατάστασης: **Ανοικτή έως … / Κλειστή**
- Υποβολή/αλλαγή ψήφου μέχρι λήξη
- Receipt (ID + timestamp)
- Manager UI για `close` + download πρακτικού/evidence

---

## 10) Security & GDPR‑friendly logging

- Rate‑limit σε submit/OTP.
- Token hashing, CSRF/session hardening σύμφωνα με υπάρχον auth flow.
- Audit με ελαχιστοποίηση προσωπικών δεδομένων.
- Πρόσβαση στα αποδεικτικά με έλεγχο δικαιωμάτων.

---

## 11) Tests (pytest + integration)

- Υποβολή/αντικατάσταση πριν τη λήξη.
- Απόρριψη μετά τη λήξη.
- Σωστή στάθμιση με χιλιοστά.
- Proxy μόνο με ενεργή εξουσιοδότηση.
- Multi‑tenant isolation.

---

## 12) Τελική σύσταση (best trade‑off)

Η επιλογή **electronic‑first + ελάχιστο safety‑valve** είναι η πιο ισορροπημένη: λειτουργικά απλή, εμπορικά ελκυστική και δύσκολα προσβάσιμη ως αποκλειστική/άδικη διαδικασία.
