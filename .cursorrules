# Cursor AI Rules - New Concierge Project

## Communication Language
- **ŒüŒπ œÄŒµœÅŒπŒ≥œÅŒ±œÜŒπŒ∫Œ≠œÇ Œ±œÄŒ±ŒΩœÑŒÆœÉŒµŒπœÇ Œ∏Œ± Œ¥ŒØŒΩŒøŒΩœÑŒ±Œπ œÉœÑŒ± ŒïŒªŒªŒ∑ŒΩŒπŒ∫Œ¨** - Descriptive responses should be provided in Greek
- **Œ£œÑŒ∑ŒΩ Œ±œÅœáŒÆ Œ∫Œ¨Œ∏Œµ ŒΩŒ≠Œ±œÇ œÉœÖŒΩŒµŒ¥œÅŒØŒ±œÇ** (ŒºŒµœÑŒ¨ Œ±œÄœå œÑŒø œÄœÅœéœÑŒø prompt) Œ∏Œ± Œ±ŒΩŒ±œÜŒ≠œÅŒµŒπœÇ Œ±ŒΩ Œ≠œáŒµŒπœÇ Œ≥ŒΩœéœÉŒ∑ œÑŒøœÖ Œ±ŒΩœÑŒπŒ∫ŒµŒπŒºŒ≠ŒΩŒøœÖ œÉŒµ Œ≤Œ±Œ∏Œºœå senior œÄœÅŒøŒ≥œÅŒ±ŒºŒºŒ±œÑŒπœÉœÑŒÆ
- **ŒòŒ± Œ¥Œ∑ŒºŒπŒøœÖœÅŒ≥ŒµŒØœÇ œÄŒ¨ŒΩœÑŒ± Œ≠ŒΩŒ± œÄŒªŒ¨ŒΩŒø Œ¥œÅŒ¨œÉŒ∑œÇ œÄŒøœÖ Œ∏Œ± ŒµœÄŒπŒªœçŒµŒπ Œ±œÄŒøœÑŒµŒªŒµœÉŒºŒ±œÑŒπŒ∫Œ¨ œÑŒø œÄœÅœåŒ≤ŒªŒ∑ŒºŒ±** - Always outline an action plan before executing
- **Œ£Œµ œÄŒµœÅŒØœÄœÑœâœÉŒ∑ Œ±œÉœÑŒøœáŒØŒ±œÇ œÉœÑŒ∑ Œ¥ŒµœçœÑŒµœÅŒ∑ Œ±œÄŒ¨ŒΩœÑŒ∑œÉŒ∑** Œ∏Œ± ŒµœÄŒπŒªŒ≠Œ≥ŒµŒπœÇ Œ¥ŒπŒ±œÜŒøœÅŒµœÑŒπŒ∫œå ŒºŒøŒΩœÑŒ≠ŒªŒø ŒºŒµ ŒπŒ∫Œ±ŒΩœåœÑŒ∑œÑŒ± Œ≤Œ±Œ∏œçœÑŒµœÅŒ∑œÇ Œ±ŒΩŒ¨ŒªœÖœÉŒ∑œÇ

## Answer Quality Standards
- **ŒîŒµŒΩ Œ∏Œ± Œ¥ŒØŒΩŒøŒΩœÑŒ±Œπ Œ±œÄŒ±ŒΩœÑŒÆœÉŒµŒπœÇ** ŒµŒ¨ŒΩ Œ¥ŒµŒΩ ŒµŒØœÉŒ±Œπ œÉŒØŒ≥ŒøœÖœÅŒøœÇ 99.99% œåœÑŒπ ŒµŒØŒΩŒ±Œπ ŒªŒµŒπœÑŒøœÖœÅŒ≥ŒπŒ∫Œ≠œÇ Œ∫Œ±Œπ œÉœçŒºœÜœâŒΩŒµœÇ ŒºŒµ œÑŒπœÇ Œ±œÄŒ±ŒπœÑŒÆœÉŒµŒπœÇ œÑŒøœÖ Œ≠œÅŒ≥ŒøœÖ
- **ŒïŒ¨ŒΩ Œ¥ŒµŒΩ ŒµŒØœÉŒ±Œπ œÉŒØŒ≥ŒøœÖœÅŒøœÇ, Œ∏Œ± œÑŒø ŒªŒµœÇ ŒµœÖŒ∏Œ±œÅœÉœéœÇ** - If you are not sure, say so honestly

---

## üèóÔ∏è Project Architecture

### Overview
**New Concierge** - SaaS ŒµœÜŒ±œÅŒºŒøŒ≥ŒÆ Œ¥ŒπŒ±œáŒµŒØœÅŒπœÉŒ∑œÇ œÄŒøŒªœÖŒ∫Œ±œÑŒøŒπŒ∫ŒπœéŒΩ ŒºŒµ multi-tenant Œ±œÅœáŒπœÑŒµŒ∫œÑŒøŒΩŒπŒ∫ŒÆ.

### Tech Stack
| Component | Technology |
|-----------|------------|
| **Backend** | Django 5.x + Django REST Framework |
| **Multi-tenancy** | django-tenants (PostgreSQL schemas) |
| **Frontend** | Next.js 14+ (App Router) + TypeScript |
| **UI Library** | Tailwind CSS + shadcn/ui |
| **State Management** | React Query (TanStack Query) |
| **Authentication** | JWT (SimpleJWT) + OAuth (Google, Microsoft) |
| **Payments** | Stripe (SaaS subscriptions) |
| **Deployment** | Railway (backend) + Vercel (frontend) |
| **Database** | PostgreSQL |

---

## üìÅ Project Structure

```
/home/theo/project/
‚îú‚îÄ‚îÄ backend/                    # Django Backend
‚îÇ   ‚îú‚îÄ‚îÄ new_concierge_backend/  # Django settings
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ settings.py         # Main settings
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ settings/base.py    # Base settings
‚îÇ   ‚îú‚îÄ‚îÄ users/                  # User management (SHARED_APPS)
‚îÇ   ‚îú‚îÄ‚îÄ tenants/                # Tenant/Client models (SHARED_APPS)
‚îÇ   ‚îú‚îÄ‚îÄ billing/                # Stripe subscriptions (SHARED_APPS)
‚îÇ   ‚îú‚îÄ‚îÄ buildings/              # Building models (TENANT_APPS)
‚îÇ   ‚îú‚îÄ‚îÄ apartments/             # Apartment models (TENANT_APPS)
‚îÇ   ‚îú‚îÄ‚îÄ financial/              # ŒöŒøŒπŒΩœåœáœÅŒ∑œÉœÑŒ±, œÄŒªŒ∑œÅœâŒºŒ≠œÇ (TENANT_APPS)
‚îÇ   ‚îú‚îÄ‚îÄ announcements/          # ŒëŒΩŒ±Œ∫ŒøŒπŒΩœéœÉŒµŒπœÇ (TENANT_APPS)
‚îÇ   ‚îú‚îÄ‚îÄ kiosk/                  # Kiosk display system (TENANT_APPS)
‚îÇ   ‚îú‚îÄ‚îÄ maintenance/            # Œ£œÖŒΩœÑŒÆœÅŒ∑œÉŒ∑ (TENANT_APPS)
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ
‚îú‚îÄ‚îÄ public-app/                 # Next.js Frontend
‚îÇ   ‚îî‚îÄ‚îÄ src/
‚îÇ       ‚îú‚îÄ‚îÄ app/                # App Router pages
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ (dashboard)/    # Protected dashboard routes
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ login/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ accept-invitation/
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ kiosk/
‚îÇ       ‚îú‚îÄ‚îÄ components/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ contexts/       # React Contexts
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AuthContext.tsx
‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ BuildingContext.tsx
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ financial/
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ       ‚îú‚îÄ‚îÄ lib/
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ api.ts          # API client
‚îÇ       ‚îî‚îÄ‚îÄ hooks/
‚îÇ
‚îî‚îÄ‚îÄ linux_version/frontend/     # Legacy frontend (deprecated)
```

---

## üîë Key Concepts

### Multi-Tenancy Architecture
```
PUBLIC SCHEMA (Shared across all tenants)
‚îú‚îÄ‚îÄ users_customuser          # All users (unique email globally)
‚îú‚îÄ‚îÄ tenants_client            # Tenant definitions
‚îú‚îÄ‚îÄ billing_*                 # Stripe subscriptions
‚îî‚îÄ‚îÄ office_staff_*

TENANT SCHEMAS (Per-tenant data)
‚îú‚îÄ‚îÄ buildings_building        # ŒöœÑŒØœÅŒπŒ±
‚îú‚îÄ‚îÄ apartments_apartment      # ŒîŒπŒ±ŒºŒµœÅŒØœÉŒºŒ±œÑŒ±
‚îú‚îÄ‚îÄ buildings_buildingmembership  # User ‚Üî Building relation
‚îú‚îÄ‚îÄ financial_*               # ŒüŒπŒ∫ŒøŒΩŒøŒºŒπŒ∫Œ¨
‚îú‚îÄ‚îÄ announcements_*           # ŒëŒΩŒ±Œ∫ŒøŒπŒΩœéœÉŒµŒπœÇ
‚îî‚îÄ‚îÄ ...
```

### User Roles
| Role | Description |
|------|-------------|
| `admin` | Superuser (platform admin) |
| `manager` | Office Manager (ŒìœÅŒ±œÜŒµŒØŒø Œ¥ŒπŒ±œáŒµŒØœÅŒπœÉŒ∑œÇ - Tenant owner) |
| `office_staff` | Œ•œÄŒ¨ŒªŒªŒ∑ŒªŒøœÇ Œ≥œÅŒ±œÜŒµŒØŒøœÖ Œ¥ŒπŒ±œáŒµŒØœÅŒπœÉŒ∑œÇ |
| `internal_manager` | ŒïœÉœâœÑŒµœÅŒπŒ∫œåœÇ Œ¥ŒπŒ±œáŒµŒπœÅŒπœÉœÑŒÆœÇ œÄŒøŒªœÖŒ∫Œ±œÑŒøŒπŒ∫ŒØŒ±œÇ |
| `resident` | ŒàŒΩŒøŒπŒ∫ŒøœÇ/ŒôŒ¥ŒπŒøŒ∫œÑŒÆœÑŒ∑œÇ |

### Important Models

**CustomUser** (`users/models.py`)
- `email` - Unique globally
- `tenant` - ForeignKey to Client (ONE tenant per user)
- `role` - SystemRole choices

**Building** (`buildings/models.py`)
- `manager_id` - Integer (cross-schema reference)
- `internal_manager` - ForeignKey to CustomUser

**BuildingMembership** (`buildings/models.py`)
- Links User ‚Üî Building
- `unique_together = ('building', 'resident')`
- Roles: resident, representative, internal_manager

**Apartment** (`apartments/models.py`)
- `owner_user`, `tenant_user` - ForeignKeys to CustomUser
- `kiosk_token` - UUID for QR code access

---

## üõ£Ô∏è Key API Endpoints

### Buildings
- `GET /api/buildings/` - List buildings
- `GET /api/buildings/my-buildings/` - User's buildings with permissions
- `GET /api/buildings/current-context/?building_id=X` - Building context + permissions

### Users/Auth
- `POST /api/users/login/` - JWT login
- `POST /api/users/register/` - Registration
- `POST /api/users/accept-invitation/` - Accept invitation
- `GET /api/users/me/` - Current user info

### Invitations
- `GET /api/users/invitations/` - List invitations
- `POST /api/users/invite/` - Create invitation
- `POST /api/kiosk/register/` - Kiosk self-registration

---

## üîß Common Patterns

### Building Context (Frontend)
```typescript
// Use BuildingContext for active building
import { useBuilding } from '@/components/contexts/BuildingContext';

const { selectedBuilding, permissions, setSelectedBuilding } = useBuilding();

// Building ID is stored in localStorage:
// - selectedBuildingId
// - activeBuildingId
```

### API Calls with Building Filter
```typescript
// Always pass building_id to scope data
const { data } = useQuery({
  queryKey: ['apartments', selectedBuilding?.id],
  queryFn: () => api.get(`/apartments/?building=${selectedBuilding?.id}`)
});
```

### Cross-Schema Queries (Backend)
```python
# Users are in public schema, buildings in tenant schema
from django_tenants.utils import schema_context

with schema_context('public'):
    user = CustomUser.objects.get(id=user_id)
```

---

## ‚ö†Ô∏è Important Considerations

### Email Uniqueness
- `CustomUser.email` is **globally unique** (not per-tenant)
- One user cannot have different accounts in different tenants
- User belongs to ONE tenant via ForeignKey

### Building Context for Multi-Building Users
- When user has access to multiple buildings:
  - `building_id` is passed in invitation URLs
  - Stored in localStorage on acceptance
  - BuildingContext auto-loads from localStorage
  - All API calls should filter by `building_id`

### Migrations
- `SHARED_APPS` migrations run on public schema
- `TENANT_APPS` migrations run on each tenant schema
- After adding fields to shared models: `python manage.py migrate_schemas --shared`
- After adding fields to tenant models: `python manage.py migrate_schemas`

---

## üîí Environment Variables

### Backend (Railway)
```
DATABASE_URL=postgresql://...
SECRET_KEY=...
FRONTEND_URL=https://your-app.vercel.app
STRIPE_SECRET_KEY=...
STRIPE_WEBHOOK_SECRET=...
```

### Frontend (Vercel)
```
NEXT_PUBLIC_CORE_API_URL=https://your-backend.railway.app
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=...
```

---

## üìù Development Commands

```bash
# Backend
cd backend
python3 manage.py runserver
python3 manage.py makemigrations
python3 manage.py migrate_schemas
python3 manage.py createsuperuser

# Frontend
cd public-app
npm run dev
npm run build
```

---

## üîó Related Documentation
- `ARCHITECTURE.md` - Detailed architecture overview
- `INVITATION_SYSTEM_FLOW.md` - Invitation system documentation
- `BUILDING_CONTEXT_REFACTORING_PLAN.md` - Building context patterns
- `REFACTORING_SUMMARY.md` - API refactoring summary
