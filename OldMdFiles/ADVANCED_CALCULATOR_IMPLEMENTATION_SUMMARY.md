# 🔧 Υλοποίηση Προηγμένου Υπολογιστή Κοινοχρήστων - Σύνοψη

## 📋 Επισκόπηση

Αυτό το έγγραφο περιγράφει την υλοποίηση του προηγμένου υπολογιστή κοινοχρήστων σύμφωνα με το TODO αρχείο. Ο νέος υπολογιστής υλοποιεί τον πλήρη αλγόριθμο με όλες τις κατηγορίες δαπανών και κανόνες κατανομής.

---

## 🏗️ Αρχιτεκτονική Υλοποίησης

### 1. Νέο Service Class: `AdvancedCommonExpenseCalculator`

**Τοποθεσία**: `backend/financial/services.py`

**Κύρια Χαρακτηριστικά**:
- ✅ Υλοποίηση του πλήρους αλγορίθμου από το TODO αρχείο
- ✅ Υποστήριξη για όλες τις κατηγορίες δαπανών
- ✅ Προηγμένος υπολογισμός θέρμανσης (πάγιο + μεταβλητό)
- ✅ Κατανομή ανά χιλιοστά για γενικές δαπάνες και ανελκυστήρα
- ✅ Ισόποση κατανομή για ειδικές δαπάνες
- ✅ Εισφορά αποθεματικού ανά διαμέρισμα

### 2. Κατηγορίες Δαπανών & Κανόνες Κατανομής

#### Γενικές Δαπάνες (Κατανομή ανά χιλιοστά συμμετοχής)
```
- cleaning (Καθαρισμός)
- electricity_common (ΔΕΗ Κοινοχρήστων)
- water_common (Νερό Κοινοχρήστων)
- garbage_collection (Συλλογή Απορριμμάτων)
- security (Ασφάλεια)
- concierge (Συνεργείο Καθαρισμού)
- building_maintenance (Συντήρηση Κτιρίου)
- building_insurance (Ασφάλεια Κτιρίου)
- και πολλές άλλες...
```

#### Δαπάνες Ανελκυστήρα (Κατανομή ανά χιλιοστά ανελκυστήρα)
```
- elevator_maintenance (Συντήρηση Ανελκυστήρα)
- elevator_repair (Επισκευή Ανελκυστήρα)
- elevator_inspection (Επιθεώρηση Ανελκυστήρα)
- elevator_modernization (Αναβάθμιση Ανελκυστήρα)
```

#### Δαπάνες Θέρμανσης (Πάγιο 30% + Μεταβλητό 70%)
```
- heating_fuel (Πετρέλαιο Θέρμανσης)
- heating_gas (Φυσικό Αέριο Θέρμανσης)
- heating_maintenance (Συντήρηση Καυστήρα)
- heating_repair (Επισκευή Θερμαντικών)
- heating_inspection (Επιθεώρηση Θερμαντικών)
- heating_modernization (Αναβάθμιση Θερμαντικών)
```

#### Ισόποσες Δαπάνες (Ίσο μερίδιο ανά διαμέρισμα)
```
- special_contribution (Έκτακτη Εισφορά)
- reserve_fund (Ταμείο Εφεδρείας)
- emergency_fund (Ταμείο Έκτακτης Ανάγκης)
- renovation_fund (Ταμείο Ανακαίνισης)
```

### 3. Παράμετροι Υπολογισμού

```python
# Προσαρμοσμένες παράμετροι
heating_fixed_percentage = Decimal('0.30')  # 30% πάγιο θέρμανσης
reserve_fund_contribution = Decimal('5.00')  # 5€ ανά διαμέρισμα
```

---

## 🔄 Αλγόριθμος Υπολογισμού

### Βήμα 1: Αρχικοποίηση Μεταβλητών
- Δημιουργία λίστας μεριδίων για κάθε διαμέρισμα
- Αρχικοποίηση όλων των πεδίων breakdown

### Βήμα 2: Υπολογισμός Συνολικών Ποσών ανά Κατηγορία
- Άθροισμα δαπανών ανά κατηγορία
- Αντιστοίχιση κατηγοριών με κανόνες κατανομής

### Βήμα 3: Υπολογισμός Δαπανών Θέρμανσης
- Υπολογισμός πάγιου κόστους (30%)
- Υπολογισμός μεταβλητού κόστους (70%)
- Λήψη μετρήσεων θέρμανσης από βάση δεδομένων
- Υπολογισμός κόστους ανά ώρα

### Βήμα 4: Κατανομή Δαπανών ανά Διαμέρισμα
- **Γενικές δαπάνες**: `ποσό × (χιλιοστά_διαμερίσματος / συνολικά_χιλιοστά)`
- **Δαπάνες ανελκυστήρα**: `ποσό × (χιλιοστά_ανελκυστήρα / συνολικά_χιλιοστά_ανελκυστήρα)`
- **Δαπάνες θέρμανσης**: 
  - Πάγιο: `πάγιο_κόστος × (χιλιοστά_θέρμανσης / συνολικά_χιλιοστά_θέρμανσης)`
  - Μεταβλητό: `ώρες_κατανάλωσης × κόστος_ανά_ώρα`
- **Ισόποσες δαπάνες**: `συνολικό_ποσό / αριθμός_διαμερισμάτων`

### Βήμα 5: Προσθήκη Ατομικών Χρεώσεων
- Υποστήριξη για συγκεκριμένα διαμερίσματα (προετοιμασία)

### Βήμα 6: Οριστικοποίηση Τελικών Ποσών
- Προσθήκη εισφοράς αποθεματικού (5€ ανά διαμέρισμα)
- Υπολογισμός συνολικού πληρωτέου ποσού

---

## 🚀 API Endpoint

### Νέο Endpoint: `/api/common-expenses/calculate_advanced/`

**Μέθοδος**: POST

**Παράμετροι**:
```json
{
    "building_id": 3,
    "period_start_date": "2025-01-01",
    "period_end_date": "2025-01-31"
}
```

**Απάντηση**:
```json
{
    "shares": {
        "1": {
            "apartment_id": 1,
            "apartment_number": "1",
            "owner_name": "Ιδιοκτήτης 1",
            "participation_mills": 85,
            "heating_mills": 85,
            "elevator_mills": 80,
            "total_amount": 189.00,
            "breakdown": {
                "general_expenses": 42.50,
                "elevator_expenses": 16.00,
                "heating_expenses": 25.50,
                "equal_share_expenses": 100.00,
                "individual_expenses": 0.00,
                "reserve_fund_contribution": 5.00
            },
            "heating_breakdown": {
                "fixed_cost": 25.50,
                "variable_cost": 0.00,
                "consumption_hours": 0
            },
            "previous_balance": 0.00,
            "total_due": 189.00
        }
    },
    "expense_totals": {
        "general": 500.00,
        "elevator": 200.00,
        "heating": 1000.00,
        "equal_share": 300.00,
        "individual": 0.00
    },
    "heating_costs": {
        "total_cost": 1000.00,
        "fixed_cost": 300.00,
        "variable_cost": 700.00,
        "total_consumption_hours": 0.00,
        "cost_per_hour": 0.0000
    },
    "total_apartments": 12,
    "calculation_date": "2025-01-08T10:30:00"
}
```

---

## 🧪 Test Results

### Λογική Υπολογιστή
```
✅ Υπολογισμός πάγιου και μεταβλητού κόστους θέρμανσης
✅ Κατανομή γενικών δαπανών ανά χιλιοστά
✅ Κατανομή δαπανών ανελκυστήρα ανά χιλιοστά
✅ Κατανομή ισόποσων δαπανών
✅ Εισφορά αποθεματικού
✅ Συνολικός υπολογισμός μεριδίων
✅ Αντιστοίχιση κατηγοριών δαπανών
```

### Παράδειγμα Υπολογισμού
```
Διαμέρισμα 1:
- Γενικές δαπάνες: 42.50€ (85χλ. / 1000χλ.)
- Δαπάνες ανελκυστήρα: 16.00€ (80χλ. / 1000χλ.)
- Δαπάνες θέρμανσης: 25.50€ (πάγιο: 25.50€, μεταβλητό: 0.00€)
- Ισόποσες δαπάνες: 100.00€
- Εισφορά αποθεματικού: 5.00€
= ΣΥΝΟΛΟ: 189.00€
```

---

## 📊 Σύγκριση με Υπάρχον Υπολογιστή

| Χαρακτηριστικό | Υπάρχον Υπολογιστής | Προηγμένος Υπολογιστής |
|----------------|---------------------|------------------------|
| Κατηγορίες δαπανών | Βασικές | Όλες οι κατηγορίες |
| Θέρμανση | Απλή κατανομή | Πάγιο + μεταβλητό |
| Ανελκυστήρας | Χιλιοστά συμμετοχής | Ειδικά χιλιοστά ανελκυστήρα |
| Ισόποσες δαπάνες | Υποστηρίζονται | Υποστηρίζονται |
| Εισφορά αποθεματικού | ❌ | ✅ |
| Ατομικές χρεώσεις | ❌ | ✅ (προετοιμασία) |
| Λεπτομερής ανάλυση | ❌ | ✅ |

---

## 🔄 Επόμενα Βήματα

### 1. Ενσωμάτωση στο Frontend
- [ ] Ενημέρωση του `CommonExpenseCalculator.tsx` component
- [ ] Προσθήκη επιλογής προηγμένου υπολογιστή
- [ ] Εμφάνιση λεπτομερούς ανάλυσης

### 2. Υλοποίηση Ατομικών Χρεώσεων
- [ ] Ενεργοποίηση του `ExpenseApartment` model
- [ ] Υλοποίηση της μεθόδου `_add_individual_charges`
- [ ] Frontend για επιλογή συγκεκριμένων διαμερισμάτων

### 3. Βελτιώσεις Θέρμανσης
- [ ] Υποστήριξη για διαφορετικούς τύπους μετρητών
- [ ] Προηγμένοι αλγόριθμοι υπολογισμού κατανάλωσης
- [ ] Ιστορικό μετρήσεων

### 4. Παράμετροι Υπολογισμού
- [ ] Δυνατότητα προσαρμογής ποσοστού πάγιου θέρμανσης
- [ ] Δυναμική εισφορά αποθεματικού
- [ ] Ειδικοί κανόνες ανά κτίριο

### 5. Αναφορές & Εξαγωγές
- [ ] Λεπτομερείς αναφορές με ανάλυση
- [ ] Εξαγωγή σε Excel/PDF
- [ ] Γραφήματα κατανομής

---

## 🎯 Συμπέρασμα

Ο προηγμένος υπολογιστής κοινοχρήστων έχει υλοποιηθεί επιτυχώς σύμφωνα με το TODO αρχείο και παρέχει:

✅ **Πλήρη υλοποίηση του αλγορίθμου**  
✅ **Υποστήριξη για όλες τις κατηγορίες δαπανών**  
✅ **Προηγμένος υπολογισμός θέρμανσης**  
✅ **Λεπτομερής ανάλυση μεριδίων**  
✅ **Ευέλικτη αρχιτεκτονική**  
✅ **Επεκτασιμότητα για μελλοντικές βελτιώσεις**  

Ο υπολογιστής είναι έτοιμος για ενσωμάτωση στο frontend και παραγωγική χρήση.
