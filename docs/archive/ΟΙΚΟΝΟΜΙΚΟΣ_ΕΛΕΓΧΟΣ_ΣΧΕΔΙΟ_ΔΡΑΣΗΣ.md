# 🚀 ΣΧΕΔΙΟ ΔΡΑΣΗΣ - ΒΕΛΤΙΩΣΗ ΟΙΚΟΝΟΜΙΚΩΝ

## 📅 Ημερομηνία: 17 Νοεμβρίου 2025

---

## 🎯 ΣΤΟΧΟΣ

**Δημιουργία πλήρως κατανοητού συστήματος επιμερισμού δαπανών** που:
1. Διαχωρίζει σαφώς τις δαπάνες Ενοίκων από τις δαπάνες Ιδιοκτητών
2. Εμφανίζει τον επιμερισμό με συνέπεια σε όλες τις views
3. Παρέχει κατανοητό ιστορικό για κάθε χρήστη
4. Βασίζεται στις ελληνικές πρακτικές πολυκατοικιών

---

## 📊 ΦΑΣΗ 1: BACKEND - ΔΙΟΡΘΩΣΕΙΣ & ΒΕΛΤΙΩΣΕΙΣ

### **Βήμα 1.1: Διόρθωση Mapping (`models.py`)**

#### Αλλαγή 1: painting_interior → shared
**Αρχείο:** `/home/theo/project/backend/financial/models.py`  
**Γραμμή:** ~268

**Πριν:**
```python
'painting_interior': 'resident',  # Βαψίματα εσωτερικών κοινοχρήστων
```

**Μετά:**
```python
'painting_interior': 'shared',  # Μικρά βαψίματα: ένοικος | Ανακαίνιση: ιδιοκτήτης
```

#### Αλλαγή 2: Προσθήκη Νέων Κατηγοριών

**Στο `EXPENSE_CATEGORIES` (γραμμή ~103):**
```python
# Προσθήκη στην ομάδα "Πάγιες Δαπάνες Κοινοχρήστων"
('deh_maintenance_fee', 'Τέλος Συντήρησης ΔΕΗ'),
('water_sewage_fee', 'Τέλος Αποχέτευσης'),

# Προσθήκη στην ομάδα "Δαπάνες Κτιρίου & Εξωτερικών Χώρων"
('common_areas_renovation', 'Ανακαίνιση Κοινοχρήστων'),

# Προσθήκη στην ομάδα "Δαπάνες Ηλεκτρικών Εγκαταστάσεων"
('generator_maintenance', 'Συντήρηση Γεννήτριας'),
('generator_repair', 'Επισκευή Γεννήτριας'),

# Προσθήκη στην ομάδα "Δαπάνες Ανελκυστήρα"
('elevator_emergency', 'Εγκλωβισμός Ανελκυστήρα'),
```

**Στο `EXPENSE_CATEGORY_DEFAULTS` (γραμμή ~223):**
```python
# Πάγιες Δαπάνες
'deh_maintenance_fee': 'resident',       # Τέλος συντήρησης ΔΕΗ
'water_sewage_fee': 'resident',          # Τέλος αποχέτευσης

# Κτίριο
'common_areas_renovation': 'owner',      # Ανακαίνιση κοινοχρήστων

# Ηλεκτρικά
'generator_maintenance': 'resident',     # Συντήρηση γεννήτριας
'generator_repair': 'owner',             # Επισκευή γεννήτριας

# Ανελκυστήρας
'elevator_emergency': 'resident',        # Έκτακτη επέμβαση εγκλωβισμού
```

**Εκτίμηση χρόνου:** 15 λεπτά

---

### **Βήμα 1.2: Προσθήκη Tooltips/Εξηγήσεων**

**Αρχείο:** `/home/theo/project/backend/financial/models.py`

Προσθήκη `EXPENSE_CATEGORY_EXPLANATIONS` dictionary:

```python
# Γραμμή ~338 (μετά το EXPENSE_CATEGORY_DEFAULTS)
EXPENSE_CATEGORY_EXPLANATIONS = {
    # Shared categories που χρειάζονται εξήγηση
    'shared': {
        'elevator_repair': 'Μικρή επισκευή: Ένοικος | Μεγάλη αντικατάσταση: Ιδιοκτήτης',
        'heating_repair': 'Μικρή επισκευή: Ένοικος | Αντικατάσταση συστήματος: Ιδιοκτήτης',
        'locksmith': 'Κοινόχρηστα κλειδιά: Ένοικος | Θύρες/ασφάλεια: Ιδιοκτήτης',
        'painting_interior': 'Μικρά βαψίματα συντήρησης: Ένοικος | Ανακαίνιση: Ιδιοκτήτης',
        'miscellaneous': 'Εξαρτάται από το είδος της δαπάνης',
        'other': 'Εξαρτάται από το είδος της δαπάνης',
    },
    # Controversial categories που χρειάζονται διευκρίνιση
    'management_fees': 'Τα διαχειριστικά είναι μέρος των τακτικών κοινοχρήστων (σύγχρονη πρακτική). Μπορεί να αλλάξει ανάλογα με τη σύμβαση μίσθωσης.',
}
```

**Serializer update:**
```python
# Στο ExpenseSerializer (serializers.py)
explanation = serializers.SerializerMethodField()

def get_explanation(self, obj):
    """Επιστρέφει εξήγηση για shared ή controversial κατηγορίες"""
    if obj.payer_responsibility == 'shared':
        return Expense.EXPENSE_CATEGORY_EXPLANATIONS.get('shared', {}).get(obj.category)
    return Expense.EXPENSE_CATEGORY_EXPLANATIONS.get(obj.category)
```

**Εκτίμηση χρόνου:** 20 λεπτά

---

### **Βήμα 1.3: Testing**

```bash
# Django shell testing
python manage.py shell

from financial.models import Expense

# Test 1: Έλεγχος νέων κατηγοριών
print([c for c in Expense.EXPENSE_CATEGORIES if 'generator' in c[0]])

# Test 2: Έλεγχος painting_interior → shared
print(Expense.get_default_payer_for_category('painting_interior'))  # Πρέπει να επιστρέψει 'shared'

# Test 3: Έλεγχος νέων defaults
print(Expense.get_default_payer_for_category('deh_maintenance_fee'))  # 'resident'
print(Expense.get_default_payer_for_category('generator_repair'))  # 'owner'
```

**Εκτίμηση χρόνου:** 10 λεπτά

---

## 🎨 ΦΑΣΗ 2: FRONTEND - ΒΕΛΤΙΩΣΕΙΣ UX

### **Βήμα 2.1: ExpenseList - Προσθήκη Φίλτρου Payer**

**Αρχείο:** `/home/theo/project/public-app/src/components/financial/ExpenseList.tsx`

**Αλλαγή 1: State για payer filter**
```typescript
// Γραμμή ~40 (μετά το categoryFilter)
const [payerFilter, setPayerFilter] = useState<string>('all');
```

**Αλλαγή 2: Προσθήκη φίλτρου στο UI**
```typescript
// Γραμμή ~525 (μετά το category filter)
<div className="space-y-2">
  <label className="text-xs font-medium text-gray-600">Ευθύνη Πληρωμής</label>
  <Select value={payerFilter} onValueChange={setPayerFilter}>
    <SelectTrigger className="text-sm">
      <SelectValue placeholder="Όλες" />
    </SelectTrigger>
    <SelectContent>
      <SelectItem value="all">👥 Όλες οι δαπάνες</SelectItem>
      <SelectItem value="resident">🟢 Δαπάνες Ενοίκων</SelectItem>
      <SelectItem value="owner">🔴 Δαπάνες Ιδιοκτητών</SelectItem>
      <SelectItem value="shared">🔵 Κοινή Ευθύνη</SelectItem>
    </SelectContent>
  </Select>
</div>
```

**Αλλαγή 3: Εφαρμογή φίλτρου**
```typescript
// Γραμμή ~570 (μέσα στο useMemo των filteredExpenses)
.filter(expense => {
  // ...existing category filter...
  
  // Payer responsibility filter
  if (payerFilter !== 'all') {
    if (expense.payer_responsibility !== payerFilter) {
      return false;
    }
  }
  
  return true;
})
```

**Αλλαγή 4: Badge στην κάθε γραμμή**
```typescript
// Γραμμή ~630 (μέσα στο expense card/row)
{expense.payer_responsibility && (
  <Badge 
    className={
      expense.payer_responsibility === 'owner' 
        ? 'bg-red-50 text-red-700 border-red-200 text-xs' 
        : expense.payer_responsibility === 'resident'
        ? 'bg-green-50 text-green-700 border-green-200 text-xs'
        : 'bg-blue-50 text-blue-700 border-blue-200 text-xs'
    }
  >
    {expense.payer_responsibility === 'owner' ? '🔴 Ιδιοκτήτης' 
      : expense.payer_responsibility === 'resident' ? '🟢 Ένοικος'
      : '🔵 Κοινή'}
  </Badge>
)}
```

**Εκτίμηση χρόνου:** 30 λεπτά

---

### **Βήμα 2.2: ExpenseBreakdown - Ομαδοποίηση**

**Αρχείο:** `/home/theo/project/public-app/src/components/financial/ExpenseBreakdown.tsx`

**Αλλαγή:** Προσθήκη ομαδοποίησης ανά payer

```typescript
// Γραμμή ~23 (μέσα στο useMemo του breakdown)
const breakdown = useMemo(() => {
  if (!expenses) return { resident: {}, owner: {}, shared: {} };

  const filteredExpenses = expenses.filter(/* ...existing filter... */);

  const breakdownByPayer = {
    resident: {} as Record<string, number>,
    owner: {} as Record<string, number>,
    shared: {} as Record<string, number>,
  };

  filteredExpenses.forEach(expense => {
    const payer = expense.payer_responsibility || 'resident';
    const category = expense.category as ExpenseCategory;
    
    if (!breakdownByPayer[payer][category]) {
      breakdownByPayer[payer][category] = 0;
    }
    breakdownByPayer[payer][category] += expense.amount;
  });

  return breakdownByPayer;
}, [expenses, period]);
```

**UI Update:**
```typescript
// Render με ομαδοποίηση
<div className="space-y-6">
  {/* Δαπάνες Ενοίκων */}
  <Card>
    <CardHeader>
      <CardTitle className="flex items-center gap-2">
        <Badge className="bg-green-50 text-green-700">🟢 Δαπάνες Ενοίκων</Badge>
      </CardTitle>
    </CardHeader>
    <CardContent>
      {/* Breakdown categories for resident */}
    </CardContent>
  </Card>
  
  {/* Δαπάνες Ιδιοκτητών */}
  <Card>
    <CardHeader>
      <CardTitle className="flex items-center gap-2">
        <Badge className="bg-red-50 text-red-700">🔴 Δαπάνες Ιδιοκτητών</Badge>
      </CardTitle>
    </CardHeader>
    <CardContent>
      {/* Breakdown categories for owner */}
    </CardContent>
  </Card>
</div>
```

**Εκτίμηση χρόνου:** 45 λεπτά

---

### **Βήμα 2.3: CommonExpenseModal - Διαχωρισμός**

**Αρχείο:** `/home/theo/project/public-app/src/components/financial/calculator/CommonExpenseModal.tsx`

Χρειάζεται έλεγχος του τι εμφανίζεται ήδη. Πιθανές προσθήκες:

1. **Tab "Δαπάνες Ενοίκων"** - Φίλτρο για resident expenses
2. **Tab "Δαπάνες Ιδιοκτητών"** - Φίλτρο για owner expenses
3. **Συνολικό breakdown** με διαχωρισμό

**Εκτίμηση χρόνου:** 60 λεπτά (μετά από έλεγχο του τρέχοντος implementation)

---

### **Βήμα 2.4: Προσθήκη Νέων Κατηγοριών στο Frontend**

**Αρχεία:**
- `/home/theo/project/public-app/src/components/financial/ExpenseForm.tsx`
- `/home/theo/project/public-app/src/components/financial/ExpenseViewModal.tsx`
- `/home/theo/project/public-app/src/types/financial.ts`

**Προσθήκη των 6 νέων κατηγοριών:**

```typescript
// ExpenseForm.tsx - EXPENSE_CATEGORIES array (γραμμή ~27)
// Προσθήκη στην ομάδα "Πάγιες Δαπάνες"
{ value: 'deh_maintenance_fee', label: 'Τέλος Συντήρησης ΔΕΗ', group: 'Πάγιες Δαπάνες' },
{ value: 'water_sewage_fee', label: 'Τέλος Αποχέτευσης', group: 'Πάγιες Δαπάνες' },

// Προσθήκη στην ομάδα "Ηλεκτρικά"
{ value: 'generator_maintenance', label: 'Συντήρηση Γεννήτριας', group: 'Ηλεκτρικά' },
{ value: 'generator_repair', label: 'Επισκευή Γεννήτριας', group: 'Ηλεκτρικά' },

// Προσθήκη στην ομάδα "Ανελκυστήρας"
{ value: 'elevator_emergency', label: 'Εγκλωβισμός Ανελκυστήρα', group: 'Ανελκυστήρας' },

// Προσθήκη στην ομάδα "Κτίριο"
{ value: 'common_areas_renovation', label: 'Ανακαίνιση Κοινοχρήστων', group: 'Κτίριο' },
```

**ExpenseViewModal.tsx - EXPENSE_CATEGORIES object (γραμμή ~27):**
```typescript
'deh_maintenance_fee': 'Τέλος Συντήρησης ΔΕΗ',
'water_sewage_fee': 'Τέλος Αποχέτευσης',
'generator_maintenance': 'Συντήρηση Γεννήτριας',
'generator_repair': 'Επισκευή Γεννήτριας',
'elevator_emergency': 'Εγκλωβισμός Ανελκυστήρα',
'common_areas_renovation': 'Ανακαίνιση Κοινοχρήστων',
```

**Εκτίμηση χρόνου:** 15 λεπτά

---

## 📊 ΦΑΣΗ 3: ΙΣΤΟΡΙΚΟ & ΑΝΑΦΟΡΕΣ

### **Βήμα 3.1: Γραφήματα Τάσεων**

**Νέο Component:** `ExpenseTrendsChart.tsx`

```typescript
interface ExpenseTrendsProps {
  expenses: Expense[];
  period: 'month' | 'quarter' | 'year';
}

// Γράφημα που δείχνει:
// - Γραμμή "Δαπάνες Ενοίκων" (πράσινη)
// - Γραμμή "Δαπάνες Ιδιοκτητών" (κόκκινη)
// - Γραμμή "Κοινή Ευθύνη" (μπλε)
// - Συνολική γραμμή (μαύρη)
```

**Χρήση:** Recharts ή Chart.js

**Εκτίμηση χρόνου:** 90 λεπτά

---

### **Βήμα 3.2: Export με Διαχωρισμό**

**Αρχείο:** `/home/theo/project/public-app/src/components/financial/calculator/utils/pdfGenerator.ts`

**Προσθήκη section στο PDF:**
```
╔═══════════════════════════════════════════════════╗
║  ΕΠΙΜΕΡΙΣΜΟΣ ΔΑΠΑΝΩΝ ΑΝΑ ΕΥΘΥΝΗ                  ║
╠═══════════════════════════════════════════════════╣
║                                                   ║
║  🟢 ΔΑΠΑΝΕΣ ΕΝΟΙΚΩΝ (Τακτικά Κοινόχρηστα)       ║
║  ──────────────────────────────────────────────  ║
║  Καθαρισμός........................... 150.00 €  ║
║  ΔΕΗ................................... 200.00 €  ║
║  Νερό.................................. 100.00 €  ║
║  Διαχειριστικά.......................... 50.00 €  ║
║  ──────────────────────────────────────────────  ║
║  ΣΥΝΟΛΟ ΕΝΟΙΚΩΝ........................ 500.00 €  ║
║                                                   ║
║  🔴 ΔΑΠΑΝΕΣ ΙΔΙΟΚΤΗΤΩΝ (Έργα & Αποθεματικό)     ║
║  ──────────────────────────────────────────────  ║
║  Αποθεματικό Ταμείο................... 300.00 €  ║
║  Ασφάλεια Κτιρίου..................... 200.00 €  ║
║  ──────────────────────────────────────────────  ║
║  ΣΥΝΟΛΟ ΙΔΙΟΚΤΗΤΩΝ.................... 500.00 €  ║
║                                                   ║
║  ΓΕΝΙΚΟ ΣΥΝΟΛΟ........................ 1000.00 €  ║
╚═══════════════════════════════════════════════════╝
```

**Εκτίμηση χρόνου:** 60 λεπτά

---

## 📝 ΦΑΣΗ 4: ΤΕΚΜΗΡΙΩΣΗ

### **Βήμα 4.1: Οδηγός Χρήσης για Χρήστες**

**Αρχείο:** `/home/theo/project/ΟΔΗΓΟΣ_ΔΙΑΧΩΡΙΣΜΟΥ_ΔΑΠΑΝΩΝ.md`

**Περιεχόμενο:**
```markdown
# Οδηγός Διαχωρισμού Δαπανών

## Γενική Αρχή

Στην Ελλάδα, ο διαχωρισμός των δαπανών μεταξύ ιδιοκτήτη και ενοίκου 
ακολουθεί την παρακάτω λογική:

### 🟢 Δαπάνες Ενοίκων (Τακτικά Κοινόχρηστα)
Ο ένοικος πληρώνει:
- Τακτική συντήρηση & καθαρισμός
- Κατανάλωση (ΔΕΗ, νερό, θέρμανση)
- Μικροεπισκευές
- Διαχειριστικά έξοδα

### 🔴 Δαπάνες Ιδιοκτητών
Ο ιδιοκτήτης πληρώνει:
- Μεγάλες επισκευές & αντικαταστάσεις
- Αναβαθμίσεις κτιρίου
- Ασφάλεια κτιρίου
- Αποθεματικό ταμείο
- Έργα πολυκατοικίας

### 🔵 Κοινή Ευθύνη
Εξαρτάται από το μέγεθος της επέμβασης:
- Μικρή επισκευή → Ένοικος
- Μεγάλη αντικατάσταση → Ιδιοκτήτης

## Λεπτομερής Κατηγοριοποίηση
[...detailed breakdown...]

## Συχνές Ερωτήσεις (FAQ)
1. Ποιος πληρώνει τα διαχειριστικά;
2. Τι γίνεται με τις έκτακτες ζημιές;
3. Πώς επιμερίζεται το αποθεματικό;
[...]
```

**Εκτίμηση χρόνου:** 90 λεπτά

---

### **Βήμα 4.2: In-App Tooltips**

**Προσθήκη tooltips στο ExpenseForm:**

```typescript
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '@/components/ui/tooltip';

// Δίπλα στο label "Ευθύνη Πληρωμής"
<TooltipProvider>
  <Tooltip>
    <TooltipTrigger>
      <Info className="h-4 w-4 text-gray-400 hover:text-gray-600" />
    </TooltipTrigger>
    <TooltipContent>
      <p className="max-w-xs">
        <strong>Ένοικος:</strong> Τακτική συντήρηση & κατανάλωση<br />
        <strong>Ιδιοκτήτης:</strong> Έργα & αποθεματικό<br />
        <strong>Κοινή:</strong> Εξαρτάται από το μέγεθος
      </p>
    </TooltipContent>
  </Tooltip>
</TooltipProvider>
```

**Εκτίμηση χρόνου:** 30 λεπτά

---

## ⏱️ ΣΥΝΟΛΙΚΗ ΕΚΤΙΜΗΣΗ ΧΡΟΝΟΥ

| Φάση | Εργασία | Χρόνος |
|------|---------|--------|
| **ΦΑΣΗ 1** | Backend διορθώσεις | 45 λεπτά |
| **ΦΑΣΗ 2** | Frontend βελτιώσεις | 180 λεπτά |
| **ΦΑΣΗ 3** | Ιστορικό & Αναφορές | 150 λεπτά |
| **ΦΑΣΗ 4** | Τεκμηρίωση | 120 λεπτά |
| **TESTING** | Δοκιμές & QA | 60 λεπτά |
| **TOTAL** | | **~9 ώρες** |

---

## 📋 ΠΡΟΤΕΡΑΙΟΤΗΤΕΣ

### 🔥 ΥΨΗΛΗ (Πρέπει να γίνουν άμεσα):
1. ✅ ExpenseList - Φίλτρο payer & Badge (30')
2. ✅ ExpenseBreakdown - Ομαδοποίηση (45')
3. ✅ Backend - Διόρθωση painting_interior (5')
4. ✅ Frontend - Νέες κατηγορίες (15')

**Υποσύνολο:** ~95 λεπτά (1.5 ώρες)

### 🟡 ΜΕΣΑΙΑ (Σημαντικά αλλά όχι επείγοντα):
5. ⚠️ CommonExpenseModal - Διαχωρισμός (60')
6. ⚠️ Backend - Νέες κατηγορίες (10')
7. ⚠️ Backend - Tooltips/Εξηγήσεις (20')

**Υποσύνολο:** ~90 λεπτά (1.5 ώρες)

### 🟢 ΧΑΜΗΛΗ (Nice to have):
8. 📊 Γραφήματα τάσεων (90')
9. 📄 Export με διαχωρισμό (60')
10. 📝 Οδηγός χρήσης (90')
11. 💬 In-app tooltips (30')

**Υποσύνολο:** ~270 λεπτά (4.5 ώρες)

---

## 🚀 ΕΠΟΜΕΝΑ ΒΗΜΑΤΑ

### Άμεση Δράση (Σήμερα):
1. ✅ Διόρθωση `painting_interior` → `shared` (Backend)
2. ✅ Προσθήκη φίλτρου payer στο `ExpenseList` (Frontend)
3. ✅ Προσθήκη badge στις γραμμές λίστας (Frontend)

### Βραχυπρόθεσμα (Αυτή την εβδομάδα):
4. ✅ Ομαδοποίηση στο `ExpenseBreakdown`
5. ✅ Προσθήκη νέων κατηγοριών (Backend + Frontend)
6. ✅ Έλεγχος `CommonExpenseModal` & βελτιώσεις

### Μεσοπρόθεσμα (Επόμενη εβδομάδα):
7. 📊 Γραφήματα τάσεων
8. 📄 Export improvements
9. 📝 Documentation

---

**Κατάσταση:** 🟡 **ΕΤΟΙΜΟ ΓΙΑ ΥΛΟΠΟΙΗΣΗ**  
**Ημερομηνία:** 17/11/2025  
**Επόμενο:** Υλοποίηση Φάσης 1 & 2 (Υψηλή προτεραιότητα)  

