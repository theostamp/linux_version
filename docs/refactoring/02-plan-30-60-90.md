# Refactoring Plan (30/60/90)

This plan is additive and deploy‑safe. Each change set is independently deployable and behind feature flags where required.

## Plan Summary
- 30 days: P0 hardening (ledger sync, debt report, secure public info + signed QR, scheduling)
- 60 days: P1 hardening (auth + permissions) + decision→task pipeline
- 90 days: P2 UX + observability

---

## Change Set 1: Feature Flags + Refactor Scaffolding
- Scope:
  - Introduce feature flags in backend settings + env schema.
  - Create shared constants/helpers for gating logic.
- Acceptance Criteria:
  - Flags readable from env and default to safe/disabled.
  - No behavior change when flags are false.
- Files changed (paths):
  - `backend/new_concierge_backend/settings/base.py`
  - `env.schema.example`
  - `backend/env.example`
- DB migrations: No.
- API changes: None.
- Frontend changes: None.
- Feature flags used:
  - `ENABLE_LEDGER_SYNC`
  - `ENABLE_KIOSK_SIGNED_QR`
  - `ENABLE_CELERY_BEAT`
  - `ENABLE_SECURE_PUBLIC_INFO`
- Tests executed (commands + αποτέλεσμα):
  - Planned: `python backend/manage.py check`.
- Manual QA steps:
  1. Boot backend with flags unset.
  2. Verify application behavior unchanged.
- Rollback plan:
  - Remove flag reads; deploy previous settings file.

---

## Change Set 2: Ledger Sync Mapping + Audit Trail (Online Payments)
- Scope:
  - Add mapping table linking `online_payments` to `financial` ledger.
  - Add audit log entries for online payments sync/manual mark‑paid.
- Acceptance Criteria:
  - New model links `Charge`/`PaymentAttempt`/`online_payments.Payment` to `financial.Payment`.
  - Manual `mark-paid` creates audit event.
- Files changed (paths):
  - `backend/online_payments/models.py`
  - `backend/online_payments/admin.py`
  - `backend/online_payments/views.py`
  - `backend/financial/audit.py`
  - `backend/online_payments/migrations/*`
- DB migrations: Yes (add mapping model and fields).
- API changes (endpoints/serializers):
  - No new public endpoints; internal sync wiring only.
- Frontend changes: None.
- Feature flags used:
  - `ENABLE_LEDGER_SYNC` (read but not yet used).
- Tests executed (commands + αποτέλεσμα):
  - Planned: model migration tests, admin smoke.
- Manual QA steps:
  1. Create charge and manual mark‑paid.
  2. Verify audit log entry is created.
- Rollback plan:
  - Revert migration and model changes; remove audit hook.

---

## Change Set 3: Webhook‑Driven Ledger Sync (Idempotent)
- Scope:
  - Implement sync service that creates/updates `financial.Payment` from Stripe webhook.
  - Ensure idempotency using Stripe `event_id` + mapping table.
- Acceptance Criteria:
  - Stripe webhook can be replayed without duplicate ledger payments.
  - Sync respects `ENABLE_LEDGER_SYNC` flag.
- Files changed (paths):
  - `backend/online_payments_public/views.py`
  - `backend/online_payments/services/*`
  - `backend/financial/models.py` (if needed for linkage fields)
  - `backend/online_payments/migrations/*` (if new fields)
  - `backend/tests/*` (new unit tests)
- DB migrations: Possibly (if new fields needed).
- API changes:
  - No new endpoints; behavior change on webhook when flag enabled.
- Frontend changes: None.
- Feature flags used:
  - `ENABLE_LEDGER_SYNC`
- Tests executed (commands + αποτέλεσμα):
  - Planned: `pytest backend/tests/test_online_payment_ledger_sync.py`.
- Manual QA steps:
  1. Simulate webhook event twice.
  2. Confirm single `financial.Payment` created.
- Rollback plan:
  - Disable flag; revert service if needed.

---

## Change Set 4: Reconciliation Report (Charges vs Ledger)
- Scope:
  - Add reconciliation endpoint to detect mismatches between `online_payments.Charge` and `financial.Payment`.
  - Optional UI surface in office dashboard.
- Acceptance Criteria:
  - API returns list of mismatches with counts and totals.
  - Endpoint is scoped per building and tenant.
- Files changed (paths):
  - `backend/online_payments/views.py` or `backend/financial/views.py`
  - `backend/online_payments/urls.py` or `backend/financial/urls.py`
  - `public-app/src/app/(dashboard)/office-dashboard/reconciliation/page.tsx`
- DB migrations: No.
- API changes:
  - New endpoint, proposed: `GET /api/online-payments/reconciliation/ledger/`.
- Frontend changes:
  - Wire UI to new endpoint (if present).
- Feature flags used:
  - `ENABLE_LEDGER_SYNC` (for safe exposure).
- Tests executed (commands + αποτέλεσμα):
  - Planned: reconciliation service unit tests.
- Manual QA steps:
  1. Create mismatch scenario (charge paid without ledger sync).
  2. Validate mismatch appears.
- Rollback plan:
  - Remove endpoint; keep services unused.

---

## Change Set 5: Debt Report + Aging Buckets
- Scope:
  - Implement `/api/financial/dashboard/debt-report/` with aging buckets.
  - Add tests for bucket classification and days overdue.
  - Optional CSV export (P1‑lite).
- Acceptance Criteria:
  - Endpoint matches frontend expectations or frontend updated to new schema.
  - Buckets: 0–30, 31–60, 61–90, 90+.
- Files changed (paths):
  - `backend/financial/views.py`
  - `backend/financial/services.py`
  - `backend/financial/urls.py`
  - `public-app/src/hooks/useFinancialDashboard.ts` (if schema changes)
  - `backend/tests/test_debt_aging.py`
- DB migrations: No.
- API changes:
  - New endpoint: `GET /api/financial/dashboard/debt-report/`.
- Frontend changes:
  - Align UI with endpoint response.
- Feature flags used:
  - None required.
- Tests executed (commands + αποτέλεσμα):
  - Planned: `pytest backend/tests/test_debt_aging.py`.
- Manual QA steps:
  1. Call endpoint with building_id and verify bucket counts.
- Rollback plan:
  - Remove endpoint; revert frontend call to existing data.

---

## Change Set 6: Secure Public Info + Signed QR
- Scope:
  - Introduce server‑issued signed QR tokens with short TTL.
  - Enforce backend sanitization for public info unless valid kiosk token is supplied.
  - Add rate limiting and audit logging for kiosk connect/register.
- Acceptance Criteria:
  - `ENABLE_KIOSK_SIGNED_QR` and `ENABLE_SECURE_PUBLIC_INFO` gate behavior.
  - Direct backend calls to public info do not expose PII without a valid token.
- Files changed (paths):
  - `backend/public_info/views.py`
  - `backend/kiosk/views.py`
  - `backend/kiosk/urls.py`
  - `backend/notifications/throttles.py` or new throttling module
  - `public-app/src/components/kiosk/widgets/QRCodeWidget.tsx`
  - `public-app/src/app/kiosk/connect/page.tsx`
  - `backend/tests/test_kiosk_public_info.py`
- DB migrations: No.
- API changes:
  - New endpoint: `POST /api/kiosk/token/` (proposed) or similar.
- Frontend changes:
  - QR widget fetches server token instead of client‑generated token.
- Feature flags used:
  - `ENABLE_KIOSK_SIGNED_QR`
  - `ENABLE_SECURE_PUBLIC_INFO`
- Tests executed (commands + αποτέλεσμα):
  - Planned: permission/throttle tests for public endpoints.
- Manual QA steps:
  1. Fetch public info without token → sanitized.
  2. Fetch with valid token → richer data as allowed.
- Rollback plan:
  - Disable flags; revert to previous public info behavior.

---

## Change Set 7: Scheduling/Automation Runner
- Scope:
  - Add production configuration for Celery worker + beat (or cron), gated by `ENABLE_CELERY_BEAT`.
  - Expose health endpoint or admin status for last runs/failures.
- Acceptance Criteria:
  - With flag enabled, periodic tasks run and log last success.
- Files changed (paths):
  - `backend/new_concierge_backend/celery.py`
  - `backend/new_concierge_backend/settings/base.py`
  - `backend/notifications/tasks.py`
  - `backend/notifications/views.py` (status endpoint)
  - `docker-compose.local.yml` (optional dev profile)
- DB migrations: No (unless tracking table is added).
- API changes:
  - New endpoint: `GET /api/notifications/tasks/status/` (proposed).
- Frontend changes:
  - Optional: status display in notifications admin UI.
- Feature flags used:
  - `ENABLE_CELERY_BEAT`
- Tests executed (commands + αποτέλεσμα):
  - Planned: smoke tests for celery config in dev.
- Manual QA steps:
  1. Enable flag, start beat, verify periodic task logs.
- Rollback plan:
  - Disable flag; tasks revert to manual triggers.

---

## Change Set 8: Auth + Permission Hardening (P1)
- Scope:
  - Reduce XSS risk (refresh token in HttpOnly cookie or CSP hardening).
  - Review AllowAny endpoints; tighten where safe without breaking kiosk.
- Acceptance Criteria:
  - Auth flow still works with new storage or CSP.
  - Public/kiosk endpoints remain functional but safer.
- Files changed (paths):
  - `backend/users/views.py` or token endpoints
  - `public-app/src/lib/api.ts`
  - `public-app/next.config.ts` (CSP headers)
  - `backend/public_info/views.py`
- DB migrations: No.
- API changes:
  - Potential new auth endpoints for cookie‑based refresh.
- Frontend changes:
  - Token storage and refresh flow update.
- Feature flags used:
  - Optional `ENABLE_SECURE_PUBLIC_INFO`.
- Tests executed (commands + αποτέλεσμα):
  - Planned: auth smoke tests.
- Manual QA steps:
  1. Login/logout flow.
  2. Token refresh on 401.
- Rollback plan:
  - Restore localStorage token flow and revert CSP.

---

## Change Set 9: Vote → Task Pipeline (Decision to Assignment)
- Scope:
  - Add a `create-task` action on votes that links a TodoItem to the Vote via `TodoLink`.
  - Ensure idempotent behavior on repeated calls.
  - Add minimal UI action on vote detail page (manager/internal).
- Acceptance Criteria:
  - `POST /api/votes/{id}/create-task/` creates a TodoItem once and links it to the vote.
  - Subsequent calls do not create duplicates (returns existing task).
  - Managers can trigger from UI; residents cannot.
- Files changed (paths):
  - `backend/votes/views.py`
  - `backend/votes/serializers.py`
  - `backend/todo_management/services.py`
  - `backend/votes/tests/test_vote_task.py`
  - `public-app/src/lib/api.ts`
  - `public-app/src/app/(dashboard)/votes/[id]/page.tsx`
- DB migrations: No.
- API changes:
  - New endpoint: `POST /api/votes/{id}/create-task/`.
- Frontend changes:
  - Add “Create task” action on vote detail page for managers.
- Feature flags used:
  - None.
- Tests executed (commands + αποτέλεσμα):
  - Planned: `python backend/manage.py test votes.tests.test_vote_task`.
- Manual QA steps:
  1. Open a vote as office manager.
  2. Click “Create task” and verify Todo item appears in `/calendar` or `/todos`.
  3. Click again; ensure no duplicate created.
- Rollback plan:
  - Remove action and UI; no data migration required.

---

## Change Set 10: Public Endpoint Throttling (Permissions Sweep)
- Scope:
  - Add rate‑limit throttling to public vote results and apartment personal endpoints.
- Acceptance Criteria:
  - Public endpoints are throttled via `KioskPublicThrottle` without breaking kiosk flows.
- Files changed (paths):
  - `backend/votes/public_views.py`
  - `backend/apartments/views_personal.py`
- DB migrations: No.
- API changes:
  - Throttle only (no schema changes).
- Frontend changes:
  - None.
- Feature flags used:
  - None.
- Tests executed (commands + αποτέλεσμα):
  - Planned: manual throttle check (burst requests).
- Manual QA steps:
  1. Call public vote results repeatedly and confirm throttling after limit.
  2. Call apartment personal endpoints repeatedly and confirm throttling.
- Rollback plan:
  - Remove throttles.

---

## 30/60/90 Breakdown

30 days
- Change Sets 1–6 (P0 delivery)

60 days
- Change Set 7 (scheduling hardening)
- Change Set 8 (auth + permissions hardening)
- Change Set 9 (vote → task pipeline)
- Change Set 10 (public endpoint throttling)

90 days
- Post‑hardening enhancements:
  - UX clarity: unified “ledger vs online charges” view.
  - Observability: webhook failure alerts and dashboards.
