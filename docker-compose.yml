#######################################################################
# SERVICES
#######################################################################
services:
  #####################################################################
  # 1. PostgreSQL
  #####################################################################
  db:
    image: postgres:15.3
    restart: unless-stopped
    environment:
      POSTGRES_DB:     ${DB_NAME:-concierge}
      POSTGRES_USER:   ${DB_USER:-concierge}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-changeme}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:            # â†³ Î¼ÏŒÎ½Î¿ Î±Î½ Ï„Î¿ Î¸ÎµÏ‚ Ï€ÏÎ¿ÏƒÎ²Î¬ÏƒÎ¹Î¼Î¿ Î±Ï€â€™ Î­Î¾Ï‰
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER}"]
      interval: 5s
      timeout: 5s
      retries: 5

  #####################################################################
  # 2. Django / Gunicorn
  #####################################################################
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    command: >
      sh -c "
        python manage.py migrate &&
        python manage.py collectstatic --noinput &&
        gunicorn new_concierge_backend.wsgi:application --bind 0.0.0.0:8000
      "
    env_file: .env           # ÏŒ,Ï„Î¹ Î­Ï‡ÎµÎ¹Ï‚ Î®Î´Î·
    environment:
      # Î•Î»Î¬Ï‡Î¹ÏƒÏ„Î± Ï€Î¿Ï… Ï‡ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹ Ï„Î¿ Django Î³Î¹Î± Î½Î± â€œÎ´ÎµÎ¹â€ Ï„Î· DB & ÎµÏ€Î¹Ï„ÏÎ­ÏˆÎµÎ¹ Host
      DATABASE_URL:   postgres://${DB_USER:-concierge}:${DB_PASSWORD:-changeme}@db:5432/${DB_NAME:-concierge}
      ALLOWED_HOSTS:  "*"
      CSRF_TRUSTED_ORIGINS: "http://localhost http://nginx http://frontend"
    volumes:
      - ./backend:/app                 # live-reload (dev) â€“ Î²Î³Î¬Î»Îµ Ï„Î¿ Î±Î½ ÎºÎ¬Î½ÎµÎ¹Ï‚ prod build
      - static_volume:/app/staticfiles
    depends_on:
      db:
        condition: service_healthy
    ports:
      - "8000:8000"                    # â†³ publish ÏƒÏ„Î¿ host Î³Î¹Î± ÎµÏÎºÎ¿Î»Î¿ debug

  #####################################################################
  # 3. Next.js (dev)  
  #    Î‘Î½ ÎºÎ¬Î½ÎµÎ¹Ï‚ prod build, Î¬Î»Î»Î±Î¾Îµ Ï„Î¿ `command` ÏƒÎµ `npm run start`
  #####################################################################
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    command: npm run dev -- --host 0.0.0.0
    # env_file: ./frontend/.env.local
    environment:
      BACKEND_URL:        http://backend:8000         # ğŸ‘ˆ Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Î±Î¹ ÏƒÏ„Î¿ next.config.js
      NEXT_PUBLIC_API_URL: http://backend:8000        # ğŸ‘ˆ ÎŸÏÎ±Ï„ÏŒ ÎºÎ±Î¹ ÏƒÏ„Î¿ browser
    volumes:
      - ./frontend:/app
      - /app/node_modules               # ÎºÏÎ±Ï„Î¬ Ï„Î± node_modules Î­Î¾Ï‰ Î±Ï€ÏŒ bind mount
    depends_on:
      - backend
    ports:
      - "3000:3000"

  #####################################################################
  # 4. Nginx reverse-proxy (Ï€ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÏŒ Î³Î¹Î± dev, Ï‡ÏÎ®ÏƒÎ¹Î¼Î¿ ÏƒÎµ prod)
  #####################################################################
  nginx:
    image: nginx:1.25
    container_name: nginx_proxy
    depends_on:
      - backend
      - frontend
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - static_volume:/app/staticfiles   # ÏƒÎµÏÎ²Î¯ÏÎµÎ¹ Ï„Î± ÏƒÏ…Î»Î»ÎµÎ³Î¼Î­Î½Î± static

#######################################################################
# VOLUMES
#######################################################################
volumes:
  postgres_data:
  static_volume:
