# Production Django Backend Dockerfile
# Multi-stage build for optimized production image

# ========================================
# ðŸ—ï¸ Build Stage
# ========================================
FROM python:3.12-slim as builder

# Build arguments
ARG BUILD_ENV=production

# Set environment variables
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1

# Install system dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    libpq-dev \
    gcc \
    && rm -rf /var/lib/apt/lists/*

# Create app user
RUN groupadd -r app && useradd -r -g app app

# Set work directory
WORKDIR /app

# Copy requirements and install Python dependencies
COPY requirements.txt .
RUN pip install --user --no-warn-script-location -r requirements.txt

# ========================================
# ðŸš€ Production Stage
# ========================================
FROM python:3.12-slim

# Set environment variables
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PYTHONPATH=/app \
    PATH=/home/app/.local/bin:$PATH

# Install system dependencies
RUN apt-get update && apt-get install -y \
    libpq5 \
    curl \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# Create app user
RUN groupadd -r app && useradd -r -g app app

# Create directories
RUN mkdir -p /app /vol/static /vol/media /app/logs \
    && chown -R app:app /app /vol /home/app

# Set work directory
WORKDIR /app

# Copy Python dependencies from builder stage
COPY --from=builder --chown=app:app /root/.local /home/app/.local

# Copy application code
COPY --chown=app:app . .

# Create entrypoint script
RUN cat > /app/entrypoint.prod.sh << 'EOF'
#!/bin/bash
set -e

echo "ðŸš€ Starting production Django application..."

# Wait for database
echo "â³ Waiting for database..."
while ! python manage.py check --database default; do
    echo "Database is unavailable - sleeping"
    sleep 1
done
echo "âœ… Database is ready!"

# Run migrations
echo "ðŸ”„ Running database migrations..."
python manage.py migrate --noinput

# Create superuser if it doesn't exist
echo "ðŸ‘¤ Creating superuser..."
python manage.py shell << PYTHON_EOF
from django.contrib.auth import get_user_model
from django.core.management.utils import get_random_secret_key
import os

User = get_user_model()
username = os.environ.get('DJANGO_SUPERUSER_USERNAME', 'admin')
email = os.environ.get('DJANGO_SUPERUSER_EMAIL', 'admin@example.com')
password = os.environ.get('DJANGO_SUPERUSER_PASSWORD', get_random_secret_key()[:12])

if not User.objects.filter(email=email).exists():
    User.objects.create_superuser(email=email, password=password)
    print(f"âœ… Superuser created: {email}")
else:
    print(f"â„¹ï¸ Superuser already exists: {email}")
PYTHON_EOF

# Collect static files
echo "ðŸ“ Collecting static files..."
python manage.py collectstatic --noinput --clear

# Create cache table
echo "ðŸ—„ï¸ Creating cache table..."
python manage.py createcachetable || echo "Cache table already exists"

# Start Gunicorn
echo "ðŸš€ Starting Gunicorn server..."
exec gunicorn new_concierge_backend.wsgi:application \
    --bind 0.0.0.0:8000 \
    --workers 4 \
    --worker-class gevent \
    --worker-connections 1000 \
    --max-requests 1000 \
    --max-requests-jitter 100 \
    --timeout 30 \
    --keep-alive 5 \
    --log-level info \
    --access-logfile /app/logs/gunicorn-access.log \
    --error-logfile /app/logs/gunicorn-error.log \
    --capture-output \
    --enable-stdio-inheritance
EOF

# Make entrypoint executable
RUN chmod +x /app/entrypoint.prod.sh

# Switch to app user
USER app

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8000/health/ || exit 1

# Expose port
EXPOSE 8000

# Set entrypoint
ENTRYPOINT ["/app/entrypoint.prod.sh"]