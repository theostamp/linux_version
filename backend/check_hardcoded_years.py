#!/usr/bin/env python3
"""
ğŸ” Script Î³Î¹Î± Î­Î»ÎµÎ³Ï‡Î¿ hardcoded ÎµÏ„ÏÎ½ ÏƒÏ„Î¿Î½ ÎºÏÎ´Î¹ÎºÎ±
"""

import os
import sys
import re
from pathlib import Path

def find_hardcoded_years(directory):
    """Î’ÏÎ¯ÏƒÎºÎµÎ¹ hardcoded Î­Ï„Î· ÏƒÏ„Î¿Î½ ÎºÏÎ´Î¹ÎºÎ±"""
    
    current_year = 2025  # Î¤ÏÎ­Ï‡Î¿Î½ Î­Ï„Î¿Ï‚
    next_year = 2026
    
    hardcoded_files = []
    
    # Patterns Î³Î¹Î± hardcoded Î­Ï„Î·
    patterns = [
        r'2024',  # Hardcoded 2024
        r'2025',  # Hardcoded 2025 (Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± ÎµÎ¯Î½Î±Î¹ ÏƒÏ‰ÏƒÏ„ÏŒ Î±Î»Î»Î¬ Î±Ï‚ Ï„Î¿ ÎµÎ»Î­Î³Î¾Î¿Ï…Î¼Îµ)
    ]
    
    # Î‘Î³Î½Î¿Î¿ÏÎ¼Îµ migration files ÎºÎ±Î¹ backup files
    ignore_patterns = [
        'migrations/',
        '.backup',
        '__pycache__/',
        '.pyc',
        'media/',
        'static/',
        'logs/',
    ]
    
    # Î‘Î³Î½Î¿Î¿ÏÎ¼Îµ ÏƒÏ‡ÏŒÎ»Î¹Î± ÎºÎ±Î¹ documentation
    comment_patterns = [
        r'# Generated by Django',
        r'# Created:',
        r'# Updated:',
        r'Updated: 2025',
        r'Created: 2025',
    ]
    
    for root, dirs, files in os.walk(directory):
        # Î‘Î³Î½Î¿Î¿ÏÎ¼Îµ ÏƒÏ…Î³ÎºÎµÎºÏÎ¹Î¼Î­Î½Î¿Ï…Ï‚ Ï†Î±ÎºÎ­Î»Î¿Ï…Ï‚
        dirs[:] = [d for d in dirs if not any(pattern in d for pattern in ignore_patterns)]
        
        for file in files:
            if file.endswith('.py'):
                file_path = os.path.join(root, file)
                
                # Î‘Î³Î½Î¿Î¿ÏÎ¼Îµ backup files
                if any(pattern in file_path for pattern in ignore_patterns):
                    continue
                
                try:
                    with open(file_path, 'r', encoding='utf-8') as f:
                        content = f.read()
                        lines = content.split('\n')
                        
                        issues = []
                        for line_num, line in enumerate(lines, 1):
                            # Î‘Î³Î½Î¿Î¿ÏÎ¼Îµ ÏƒÏ‡ÏŒÎ»Î¹Î± ÎºÎ±Î¹ documentation
                            if any(pattern in line for pattern in comment_patterns):
                                continue
                                
                            # Î‘Î³Î½Î¿Î¿ÏÎ¼Îµ migration files
                            if 'migrations/' in file_path and '# Generated by Django' in line:
                                continue
                            
                            # Î•Î»Î­Î³Ï‡Î¿Ï…Î¼Îµ Î³Î¹Î± hardcoded Î­Ï„Î·
                            for pattern in patterns:
                                if re.search(pattern, line):
                                    # Î•Î»Î­Î³Ï‡Î¿Ï…Î¼Îµ Î±Î½ ÎµÎ¯Î½Î±Î¹ ÏƒÎµ string Î® comment
                                    if ('"' + pattern + '"' in line or 
                                        "'" + pattern + "'" in line or
                                        f'date({pattern}' in line or
                                        f'year={pattern}' in line or
                                        f'__year={pattern}' in line or
                                        f'date__year={pattern}' in line):
                                        
                                        issues.append({
                                            'line': line_num,
                                            'content': line.strip(),
                                            'pattern': pattern
                                        })
                        
                        if issues:
                            hardcoded_files.append({
                                'file': file_path,
                                'issues': issues
                            })
                
                except Exception as e:
                    print(f"âŒ Î£Ï†Î¬Î»Î¼Î± ÏƒÏ„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ {file_path}: {e}")
    
    return hardcoded_files

def suggest_fixes(hardcoded_files):
    """Î ÏÎ¿Ï„ÎµÎ¯Î½ÎµÎ¹ Î´Î¹Î¿ÏÎ¸ÏÏƒÎµÎ¹Ï‚ Î³Î¹Î± hardcoded Î­Ï„Î·"""
    
    suggestions = []
    
    for file_info in hardcoded_files:
        file_path = file_info['file']
        issues = file_info['issues']
        
        file_suggestions = {
            'file': file_path,
            'suggestions': []
        }
        
        for issue in issues:
            line = issue['content']
            pattern = issue['pattern']
            
            if pattern == '2024':
                if 'date__year=2024' in line:
                    suggestion = line.replace('date__year=2024', 'date__year=current_year')
                    file_suggestions['suggestions'].append({
                        'line': issue['line'],
                        'original': line,
                        'suggestion': suggestion,
                        'reason': 'Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÏ„Îµ current_year = datetime.now().year'
                    })
                elif 'datetime(2024,' in line:
                    suggestion = line.replace('datetime(2024,', 'datetime(current_year,')
                    file_suggestions['suggestions'].append({
                        'line': issue['line'],
                        'original': line,
                        'suggestion': suggestion,
                        'reason': 'Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÏ„Îµ current_year Î±Î½Ï„Î¯ Î³Î¹Î± hardcoded 2024'
                    })
                elif '"2024"' in line or "'2024'" in line:
                    suggestion = line.replace('"2024"', 'f"{current_year}"').replace("'2024'", "f'{current_year}'")
                    file_suggestions['suggestions'].append({
                        'line': issue['line'],
                        'original': line,
                        'suggestion': suggestion,
                        'reason': 'Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÏ„Îµ f-string Î¼Îµ current_year'
                    })
        
        if file_suggestions['suggestions']:
            suggestions.append(file_suggestions)
    
    return suggestions

def main():
    """ÎšÏÏÎ¹Î± ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ·"""
    
    print("ğŸ” Î•Î›Î•Î“Î§ÎŸÎ£ HARDCODED Î•Î¤Î©Î Î£Î¤ÎŸÎ ÎšÎ©Î”Î™ÎšÎ‘")
    print("=" * 70)
    
    # ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Ï„Î¿Ï… backend directory
    backend_dir = os.path.join(os.path.dirname(__file__))
    
    print(f"ğŸ“ ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ directory: {backend_dir}")
    print()
    
    hardcoded_files = find_hardcoded_years(backend_dir)
    
    if not hardcoded_files:
        print("âœ… Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ hardcoded Î­Ï„Î·!")
        return
    
    print(f"âŒ Î’ÏÎ­Î¸Î·ÎºÎ±Î½ {len(hardcoded_files)} Î±ÏÏ‡ÎµÎ¯Î± Î¼Îµ hardcoded Î­Ï„Î·:")
    print()
    
    for file_info in hardcoded_files:
        print(f"ğŸ“„ {file_info['file']}")
        for issue in file_info['issues']:
            print(f"   Line {issue['line']}: {issue['content']}")
        print()
    
    # Î ÏÎ¿Ï„Î¬ÏƒÎµÎ¹Ï‚ Î´Î¹Î¿ÏÎ¸ÏÏƒÎµÏ‰Î½
    suggestions = suggest_fixes(hardcoded_files)
    
    if suggestions:
        print("ğŸ”§ Î Î¡ÎŸÎ¤Î‘Î£Î•Î™Î£ Î”Î™ÎŸÎ¡Î˜Î©Î£Î•Î©Î:")
        print("=" * 70)
        
        for suggestion in suggestions:
            print(f"ğŸ“„ {suggestion['file']}")
            for fix in suggestion['suggestions']:
                print(f"   Line {fix['line']}:")
                print(f"   âŒ {fix['original']}")
                print(f"   âœ… {fix['suggestion']}")
                print(f"   ğŸ’¡ {fix['reason']}")
                print()
    
    print("=" * 70)
    print("âœ… ÎŸ Î­Î»ÎµÎ³Ï‡Î¿Ï‚ Î¿Î»Î¿ÎºÎ»Î·ÏÏÎ¸Î·ÎºÎµ!")

if __name__ == "__main__":
    main()
