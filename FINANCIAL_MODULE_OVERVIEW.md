# Επισκόπηση Υποσυστήματος Οικονομικής Διαχείρισης

Αυτό το έγγραφο παρέχει μια τεχνική ανάλυση της αρχιτεκτονικής και της ροής δεδομένων για την οικονομική διαχείριση του κτιρίου, με έμφαση στον υπολογισμό και την εμφάνιση των κοινοχρήστων.

## Ροή Δεδομένων & Αρχιτεκτονική

Η διαδικασία για την εμφάνιση των οικονομικών στοιχείων, από τη συνοπτική προβολή έως το αναλυτικό φύλλο κοινοχρήστων, ακολουθεί μια σαφή αρχιτεκτονική client-server.

### 1. Συνοπτική Προβολή (Dashboard)

Η κύρια οθόνη σύνοψης (dashboard) παρέχει μια γρήγορη, γενική εικόνα της οικονομικής κατάστασης του κτιρίου για έναν συγκεκριμένο μήνα.

-   **Frontend Component**: `frontend/components/financial/calculator/BuildingOverviewSection.tsx`
    -   Αυτό το React component είναι υπεύθυνο για την εμφάνιση των καρτών με τα βασικά οικονομικά μεγέθη (Συνολικές Δαπάνες, Υποχρεώσεις, Αποθεματικό κ.λπ.).
-   **API Endpoint**: `GET /financial/dashboard/summary/`
    -   Το component καλεί αυτό το endpoint, περνώντας το `building_id` και τον επιλεγμένο μήνα (`month=YYYY-MM`).
-   **Backend View**: `backend/financial/views.py` -> `FinancialDashboardViewSet.summary`
    -   Αυτή η view χειρίζεται το αίτημα.
-   **Backend Service**: `backend/financial/services.py` -> `FinancialDashboardService.get_summary()`
    -   Εδώ γίνεται όλη η λογική. Η υπηρεσία υπολογίζει τα συνολικά ποσά (δαπάνες, πληρωμές, υπόλοιπα) με βάση τα δεδομένα από τη βάση, φιλτράροντας τα στοιχεία που αφορούν τον συγκεκριμένο μήνα όπου χρειάζεται.

### 2. Αναλυτικό Φύλλο Κοινοχρήστων

Όταν ο χρήστης ζητά την αναλυτική κατάσταση, το σύστημα εκτελεί έναν λεπτομερή υπολογισμό για να κατανείμει τις δαπάνες σε κάθε διαμέρισμα.

-   **Frontend Hook**: `frontend/hooks/useCommonExpenses.ts`
    -   Η συνάρτηση `calculateAdvancedShares` καλείται, συνήθως από το component που διαμορφώνει το φύλλο κοινοχρήστων.
-   **API Endpoint**: `POST /financial/common-expenses/calculate_advanced/`
    -   Το hook στέλνει ένα αίτημα σε αυτό το endpoint, παρέχοντας το `building_id` και, το πιο σημαντικό, τις ημερομηνίες `period_start_date` και `period_end_date` που αντιστοιχούν στην επιλεγμένη περίοδο.
-   **Backend View**: `backend/financial/views.py` -> `CommonExpenseViewSet.calculate_advanced`
    -   Αυτή η view λαμβάνει τις ημερομηνίες και τις προωθεί στην υπηρεσία υπολογισμού.
-   **Backend Service**: `backend/financial/services.py` -> `AdvancedCommonExpenseCalculator.calculate_advanced_shares()`
    -   Αυτή η κλάση περιέχει τον σύνθετο αλγόριθμο. Φιλτράρει τις ανέκδοτες δαπάνες (`Expense` model) μέσα στο παρεχόμενο χρονικό διάστημα και τις κατανέμει στα διαμερίσματα (`Apartment` model) βάσει κανόνων (χιλιοστά, ισόποσα, μετρητές κ.λπ.).

### Βασικά Μοντέλα Βάσης Δεδομένων (Models)

-   `financial/models.py`:
    -   `Expense`: Αντιπροσωπεύει μια δαπάνη του κτιρίου.
    -   `Payment`: Αντιπροσωπεύει μια είσπραξη από ένα διαμέρισμα.
    -   `Transaction`: Καταγράφει κάθε οικονομική κίνηση στο σύστημα.
    -   `ApartmentShare`: Αποθηκεύει το μερίδιο ενός διαμερίσματος σε μια συγκεκριμένη περίοδο κοινοχρήστων.
-   `buildings/models.py`:
    -   `Building`: Περιέχει τις ρυθμίσεις του κτιρίου, όπως το `reserve_fund_goal`.
-   `apartments/models.py`:
    -   `Apartment`: Περιέχει τα στοιχεία του διαμερίσματος, όπως το `current_balance` και τα χιλιοστά συμμετοχής.

### Συμπέρασμα & Διασφάλιση Συνέπειας

Η συνέπεια μεταξύ της σύνοψης και του αναλυτικού φύλλου εξαρτάται από τη σωστή επικοινωνία μεταξύ frontend και backend. Το backend είναι δομημένο σωστά ώστε να φιλτράρει τις δαπάνες με βάση το παρεχόμενο χρονικό εύρος. Είναι κρίσιμο το frontend να μετατρέπει τον επιλεγμένο μήνα (π.χ., "2025-08") σε ακριβείς ημερομηνίες έναρξης και λήξης (π.χ., "2025-08-01" και "2025-08-31") όταν καλεί το endpoint `calculate_advanced`.

---

## Προτεινόμενες Βελτιώσεις (TODO)

-   [ ] **UI/UX: Αναδιοργάνωση Εμφάνισης**: Ανασχεδιασμός των ετικετών, των στατιστικών και των banners στο `BuildingOverviewSection.tsx` για βελτίωση της οπτικής ιεραρχίας, της συνέπειας και της σαφήνειας. Εξάλειψη περιττών ή διπλότυπων ενεργειών.
-   [ ] **Backend Refactoring: Απλοποίηση `FinancialDashboardService`**: Αναδιάρθρωση της μεθόδου `get_summary` για να απομονωθεί η λογική υπολογισμού των χρονικών περιόδων (μήνας, τρέχουσα κατάσταση) σε helper functions. Αυτό θα βελτιώσει την αναγνωσιμότητα και θα μειώσει την επανάληψη κώδικα.
-   [ ] **Backend Testing: Προσθήκη Unit Tests**: Υλοποίηση ενός συνόλου από unit tests για τις κλάσεις `FinancialDashboardService` και `AdvancedCommonExpenseCalculator`. Τα tests πρέπει να καλύπτουν βασικά σενάρια υπολογισμών, οριακές περιπτώσεις (π.χ., μήνας χωρίς δαπάνες) και την ακρίβεια των οικονομικών αθροισμάτων.
-   [ ] **Frontend State Management: Κεντρική Διαχείριση Ημερομηνιών**: Δημιουργία ενός κεντρικού μηχανισμού (π.χ., custom hook ή context) στο frontend για τη διαχείριση της επιλεγμένης περιόδου (μήνας, ημερομηνίες έναρξης/λήξης). Αυτό θα διασφαλίσει ότι όλα τα components που σχετίζονται με τα οικονομικά χρησιμοποιούν την ίδια ακριβώς χρονική περίοδο, αποτρέποντας αποκλίσεις.
-   [ ] **Backend Architecture: Ενοποίηση των Calculators**: Αξιολόγηση της δυνατότητας συγχώνευσης των `CommonExpenseCalculator` και `AdvancedCommonExpenseCalculator` σε μία, πιο ευέλικτη και παραμετροποιήσιμη υπηρεσία. Αυτό θα μειώσει τη συντήρηση διπλού κώδικα και θα απλοποιήσει την αρχιτεκτονική.
